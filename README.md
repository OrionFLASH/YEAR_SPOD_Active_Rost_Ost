# YEAR_SPOD_Active_Rost_Ost

## 1. Формулировка задачи и ТЗ
- Вся бизнес-логика должна находиться в единственном файле `src/main.py`. Используются только стандартные модули Python и базовый набор Anaconda 3.9 (`pandas`, `openpyxl` и пр.), установка дополнительных пакетов через `pip` запрещена.
- На вход поступают два XLSX-файла из каталога `IN`:
  - T-0: `АКТИВЫ 31-10-2025 (ОСТАТОК-V2).xlsx`;
  - T-1: `АКТИВЫ 31-12-2024 (ОСТАТОК-V2).xlsx`.
- Читается лист `Sheet1`, обязательные колонки и их бизнес-смысл:
  - `ТБ` — территориальный банк (строка);
  - `ГОСБ` — полное название ГОСБ (строка);
  - `ВКО` — ФИО клиентского менеджера (строка);
  - `Таб. номер ВКО` — табельный номер менеджера (строка фиксированной длины; длина и символ заполнения задаются параметрами);
  - `ИНН` — идентификатор клиента (строка фиксированной длины);
  - `Остаток срочной задолженности по основному долгу` — факт (число).
- Предварительная обработка:
  - строки с запрещёнными значениями удаляются (настройки задаются по колонкам);
  - текстовые поля нормализуются;
  - табельные номера и ИНН приводятся к заданной длине с лидирующими символами;
  - факт преобразуется к числовому типу с разделителем `,`.
- Ключевые требования по логике:
  - Рассчитать прирост `Прирост = Факт_T0 - Факт_T1` для набора листов `ID`, `ID+ТБ`, `ID+ТН`, `ID+ТБ+ТН`.
  - На каждом листе определить менеджеров двумя способами: «по каждому файлу» (доминирующий в T-0/T-1) и «последний» (T-0, иначе T-1, иначе заглушка `"Не найден КМ"` / `90000009`).
  - Сформировать листы агрегирования по уникальным `ТН+ВКО` и `ТН+ВКО+ТБ`, а также прямые своды по КМ.
  - Построить выгрузку СПОД (Excel и CSV) с колонками `MANAGER_PERSON_NUMBER`, `CONTEST_CODE`, `TOURNAMENT_CODE`, `CONTEST_DATE`, `PLAN_VALUE`, `FACT_VALUE`, `priority_type`. Форматы чисел (`0.00000`) и длины (`20` символов для табельного номера) фиксированы.
- Требования к форматированию Excel:
  - Заголовок — жирный, перенос по строкам; строки с данными — перенос по словам.
  - Ширина столбцов ограничена диапазоном 70–200 символов и подбирается по содержимому.
  - Включены `freeze panes` (ячейка `A2`) и автофильтр на всём диапазоне.
- Имена файлов (`OUT` и `log`) содержат префикс из настроек и суффикс `_YYYYMMDD_HH_MM`.
- Логирование ведётся в двух файлах (INFO и DEBUG). INFO дублируется в консоль, DEBUG содержит полные сообщения вида `дата время - [DEBUG] - ... [class: ... | def: ...]`.

## 2. Методология расчёта
Начиная с версии 1.7.0 расчёт выполняется по единственному сценарию. Вместо матрицы из восьми листов мы управляем тремя параметрами и формируем только нужные таблицы: деталь, свод по табельным номерам и процентильную аналитику.

### 2.1 Оси параметров
1. **`key_mode`** — уровень агрегации:
   - `client`: ключом служит `client_id` (ИНН). Все факты клиента привязываются к выбранному КМ.
   - `manager`: ключом служит `manager_id`. Каждому КМ достаются только его собственные строки из исходных файлов.
2. **`include_tb`** — если `True`, в ключ добавляется `tb` и суммы считаются только по совпадающему ТерБанку.
3. **`manager_assignment`** — способ выбора КМ:
   - `latest`: берём доминантного КМ из T-0, затем из T-1, иначе подставляем заглушку. Вся строка (T0, T1, прирост) записывается выбранному менеджеру.
   - `per_file`: формируем две строки (для T0 и T1). Положительная часть прироста закрепляется за КМ T0, отрицательная (в абсолютном выражении) — за КМ T1. Так видно, кто «выиграл» и кто «проиграл» клиента/объект.

### 2.2 Деталь и своды
- **`DETAIL_SCENARIO`** — детальный лист с ключами (`ИНН` или табельный номер + ТБ), выбранным КМ, фактами `Факт_T0`, `Факт_T1`, `Прирост` и (в режиме `per_file`) колонкой `Источник` (`T0`/`T1`). Это позволяет увидеть долю прироста из каждого файла.
- **`SUMMARY_TN`** — агрегированные суммы по `Таб. номер ВКО (выбранный)` (и `ТБ`, если он участвует в ключе). Дополнительно выводится `Количество записей`, а метрика `Прирост` используется как источник и для процентилей, и для СПОД.

Даже при единственном сценарии обе таблицы формируются всегда: видна «общая» агрегация и построенные на ней метрики «кто лучше/хуже меня».

### 2.3 Процентильная аналитика
На базе свода автоматически строится лист `PERCENTILE_TN`:
- рассчитываются пары метрик «Обогнал / Обогнали меня» по всему массиву и по строкам с `Прирост ≥ 0`;
- при включённом ТБ добавляются аналогичные показатели внутри ТерБанков.

Все процентные значения округляются до двух знаков и сохраняются в Excel с форматом `#,##0.00`, поэтому требования к виду чисел выполняются и в детале, и в итогах, и в СПОД.

### 2.4 Выгрузка СПОД
- Основной сценарий формирует расчётный лист `CALC_MAIN` (если он указан в варианте) и итоговый лист `SPOD_MAIN`.
- Список `spod_variants` позволяет выбрать источник (`scenario_detail`, `scenario_summary`, `scenario_percentile`), колонку показателя, фильтр факта и параметры конкурса; опция `include_in_csv` добавляет данные в общий CSV.
- В Excel попадают только те листы, что разрешены блоком `report_layout`, поэтому можно ограничиться, например, деталью, итогом, процентилем и конкретными листами СПОД без остальных вкладок.

## 3. Описание решения
- Вся бизнес-логика реализована в одном файле `src/main.py` и использует только стандартную библиотеку Python плюс `pandas`.
- Сценарий описывается параметрами `scenario`: выбираем ключ (`ИНН` или табельный номер), необходимость разреза по ТБ и способ назначения КМ (`latest` или `per_file`).
- После очистки исходных файлов формируется единый набор данных, далее — таблица назначений (деталь), свод по табельным номерам и процентильный лист. Все числовые поля форматируются средствами `openpyxl`.
- Выгрузка СПОД (Excel и CSV) конфигурируется в `spod_variants`. По умолчанию экспортируется `Прирост`, но можно указать другой показатель и собственные имена листов.
- В книгу всегда попадают листы `DETAIL_SCENARIO`, `SUMMARY_TN`, `PERCENTILE_TN`, `RAW_T0`, `RAW_T1`. Остальные вкладки создаются только если они перечислены в `report_layout`.
- Логи ведутся раздельно для уровней INFO/DEBUG в каталоге `log`, INFO дополнительно выводится в консоль.

## 4. Структура каталогов
```
YEAR_SPOD_Active_Rost_Ost/
├── Docs/               # Папка для дополнительных материалов (после объединения документации может быть пустой)
├── IN/                 # Входные XLSX-файлы (T-0 и T-1)
├── OUT/                # Итоговые Excel и CSV файлы
├── log/                # Логи INFO/DEBUG
├── src/
│   ├── main.py         # Основной скрипт
│   └── Tests/README.md # Состояние автотестов
└── README.md           # Текущая документация (включает полное ТЗ и методологию)
```

## 5. Настройка окружения
1. Создать и активировать виртуальное окружение:
   ```bash
   cd ~/Desktop/MyProject/YEAR_SPOD_Active_Rost_Ost
   python3 -m venv .venv
   source .venv/bin/activate
   ```
2. Установки через `pip` не требуются (используется базовый набор Anaconda / стандартная библиотека).
3. (Опционально) Скопировать `.env.example` в `.env`, если планируется возвращение к внешней конфигурации. По умолчанию все параметры уже прошиты в `src/main.py` и сведены в дерево настроек.

## 6. Конфигурация
Вся настройка сведена в одну структуру, которую формирует функция `build_settings_tree()`:

1. **files** — описание входных XLSX.
   - `items` (`current`/`previous`): имя файла в `IN`, метка периода и лист.
   - `columns`: alias ↔ оригинальный заголовок в Excel.
2. **filters** — правила очистки (`drop_rules`).
3. **defaults** — заглушки ФИО/табельного номера.
4. **identifiers** — форматирование `manager_id` и `client_id`.
5. **spod** — префикс имён Excel/CSV и тема логов.
6. **scenario** — главный блок настроек расчёта:
   - `key_mode`: `client` или `manager`.
   - `include_tb`: учитывать ли ТБ в ключе.
   - `manager_assignment`: `latest` или `per_file`.
   - `detail_sheet_name` / `summary_sheet_name` / `percentile_sheet_name` — имена листов в Excel.
7. **spod_variants** — список выгрузок SPOD. Для каждой записи задаются `source_type` (`scenario_detail`, `scenario_summary`, `scenario_percentile`), `value_column`, фильтр факта и атрибуты конкурса. `calc_sheet_name` и `spod_sheet_name` управляют именами листов, `include_in_csv` добавляет вариант в объединённый CSV. Режим `per_file` корректно учитывает раздельные вклады T0/T1, потому что источником, как правило, служит `SUMMARY_TN`, где приросты по каждому КМ уже сведены.
8. **report_layout** — whitelists листов Excel:
   - `detail_sheets`, `summary_sheets`, `percentile_sheets`, `calc_sheets`, `spod_variants`, `raw_sheets`.
   - Значение `null` означает «не ограничивать блок», пустой список — отключить его.

Любой параметр меняется прямо в соответствующем блоке структуры; остальные функции получают настройки автоматически.

## 7. Использование
1. Поместите исходные файлы в каталог `IN` под именами:
   - `АКТИВЫ 31-10-2025 (ОСТАТОК-V2).xlsx` (T-0)
   - `АКТИВЫ 31-12-2024 (ОСТАТОК-V2).xlsx` (T-1)
2. Запустите скрипт:
   ```bash
   python src/main.py
   ```
3. Результаты появятся в каталоге `OUT` в виде Excel и CSV файлов с суффиксом `_YYYYMMDD_HH_MM`. Каждый сценарий из `spod_variants` получает:
   - расчётный лист `calc_sheet_name` (если он включён в `report_layout`) с исходной таблицей;
   - лист `spod_sheet_name` с подготовленной таблицей SPOD (лист попадает в книгу только если сам сценарий разрешён в `report_layout`).

   CSV-файл содержит объединённые данные всех вариантов, где `include_in_csv=True`. Excel формирует только те листы, которые перечислены в блоке `report_layout`. Настройки по умолчанию:
   - `DETAIL_SCENARIO` — детальные строки с назначенными КМ;
   - `SUMMARY_TN` — агрегированный итог по табельным номерам (и ТБ, если он участвует в ключе);
   - `PERCENTILE_TN` — процентильная аналитика «кого обогнал / кто обогнал меня»;
   - `RAW_T0`, `RAW_T1` — очищенные исходные данные.
   Остальные вкладки можно подключать адресно, добавив их имена в соответствующие whitelists `report_layout`.
4. Логи формирования находятся в `log/INFO_*` и `log/DEBUG_*`.

## 8. Логирование
- INFO: ключевые этапы обработки, пишутся в файл `INFO_<topic>_<timestamp>.log` и дублируются в консоль.
- DEBUG: подробные сообщения для каждой функции с указанием класса и имени функции, записываются в `DEBUG_<topic>_<timestamp>.log`.
- Формат DEBUG строки: `YYYY-MM-DD HH:MM:SS - [DEBUG] - Сообщение [class: <...> | def: <...>]`.
- При возникновении исключений основной сценарий фиксирует сообщение в INFO и полную трассировку (в одну строку) в DEBUG, после чего пробрасывает ошибку наружу.

## 9. Список функций и примеры использования
| Функция / структура | Назначение | Пример вызова |
|--------------------|-----------|---------------|
| `build_settings_tree()` | Возвращает полную вложенную структуру настроек | `settings = build_settings_tree()` |
| `build_column_profiles(columns)` | Строит маппинг alias↔оригинал | `profiles = build_column_profiles(settings['files']['columns'])` |
| `build_drop_rules(rules)` | Преобразует список запретов к dict | `rules = build_drop_rules(settings['filters']['drop_rules'])` |
| `get_file_meta(file_section, key)` | Возвращает описание нужного Excel | `current = get_file_meta(settings['files'], 'current')` |
| `resolve_sheet_name(file_section, key)` | Определяет имя листа файла | `sheet = resolve_sheet_name(settings['files'], 'current')` |
| `parse_contest_date(date_str)` | Переводит дату турнира `DD/MM/YYYY` к ISO | `iso = parse_contest_date('31/10/2025')` |
| `get_manager_columns(mode)` | Возвращает колонки для режима назначения КМ | `cols = get_manager_columns('latest')` |
| `build_filter_mask(series, condition)` | Формирует маску для фильтра `FACT_VALUE` | `mask = build_filter_mask(df['Прирост'], '>=0')` |
| `ensure_directories(paths)` | Создаёт недостающие каталоги | `ensure_directories([Path('IN')])` |
| `timestamp_suffix()` | Возвращает строку `_YYYYMMDD_HH_MM` | `suffix = timestamp_suffix()` |
| `format_identifier(value, length, char)` | Форматирует идентификаторы с лидирующими символами | `format_identifier('85461', 8, '0') -> '00085461'` |
| `safe_to_float(value)` | Безопасно приводит строку к `float` | `safe_to_float('43,51') -> 43.51` |
| `normalize_string(value)` | Очищает текстовое поле | `normalize_string('  ABC ') -> 'ABC'` |
| `build_logger(log_dir, topic)` | Возвращает функции `info`/`debug` | `logger = build_logger(Path('log'), 'spod')` |
| `log_info(logger, message)` | Записывает INFO без классов | `log_info(logger, 'Старт обработки')` |
| `log_debug(logger, message, class, func)` | Записывает DEBUG | `log_debug(logger, '...', 'Cleaner', 'drop_forbidden_rows')` |
| `read_source_file(path, sheet, columns, rules, ids, logger)` | Загружает Excel, нормализует данные | `df = read_source_file(file_path, 'Sheet1', rename_map, rules, identifiers, logger)` |
| `drop_forbidden_rows(df, rules, logger)` | Удаляет строки с запрещёнными значениями | `cleaned = drop_forbidden_rows(df, rules, logger)` |
| `aggregate_facts(df, keys, suffix, logger, variant)` | Суммирует факт по ключу | `agg = aggregate_facts(df, ['client_id'], 'T0', logger, 'ID')` |
| `select_best_manager(df, keys, logger, variant)` | Определяет менеджера с максимальным фактом | `best = select_best_manager(df, ['client_id'], logger, 'ID')` |
| `build_latest_manager(curr, prev, keys, defaults, ids, logger, variant)` | Комбинирует актуального менеджера | `latest = build_latest_manager(curr, prev, ['client_id'], defaults, identifiers, logger, 'ID')` |
| `assemble_variant_dataset(variant, keys, df_t0, df_t1, defaults, ids, logger)` | Строит итоговый набор данных для листа | `variant_tables['ID'] = assemble_variant_dataset('ID', ['client_id'], df_t0, df_t1, defaults, identifiers, logger)` |
| `build_manager_summary(df, include_tb, logger, name, manager_cols)` | Готовит свод по ТН/ВКО с выбранным режимом КМ | `summary = build_manager_summary(variant_tables['ID_TN'], False, logger, 'TN_VKO', get_manager_columns('latest'))` |
| `build_direct_manager_summary(df_t0, df_t1, include_tb, logger, name)` | Суммирует факты напрямую по КМ (и опционально ТБ) | `direct = build_direct_manager_summary(current_df, previous_df, False, logger, 'MANAGER_DIRECT')` |
| `format_excel_sheet(writer, sheet, df)` | Применяет оформление листа | `format_excel_sheet(writer, 'ID', df)` |
| `format_decimal_string(value)` | Приводит число к строке вида `0.00000` | `format_decimal_string(12.3) -> '12.30000'` |
| `append_percentile_columns(table, value_column, tb_column)` | Добавляет восемь колонок процентных рангов «обогнал/обогнали» (см. `Docs/percentile_logic.md`) | `augmented = append_percentile_columns(summary, value_column='Прирост', tb_column='ТБ')` |
| `build_spod_dataset(table, value_column, fact_filter, plan, priority, contest_codes, ids, logger, name)` | Создаёт таблицу SPOD для конкретного сценария (`spod_variants`) | `spod = build_spod_dataset(summary, value_column='Прирост', fact_value_filter='>0', plan_value=0, priority='1', contest_code='...', tournament_code='...', contest_date='31/10/2025', identifiers=identifiers, logger=logger, dataset_name='SPOD_V7')` |
| `rename_output_columns(df, alias_map)` | Возвращает русские подписи колонок | `rename_output_columns(table, profiles['alias_to_source'])` |
| `format_raw_sheet(df, alias_map)` | Подготавливает листы `RAW_T0/RAW_T1` | `raw = format_raw_sheet(current_df, profiles['alias_to_source'])` |
| `build_assignment_table(df, key_columns, assignment, defaults, ids, logger, name)` | Формирует таблицу назначений (ключ ↔ выбранный КМ) | `assignments = build_assignment_table(variant_df, key_columns, 'latest', defaults, identifiers, logger, 'SCENARIO')` |
| `build_assignment_summary(assignments, include_tb, logger, name)` | Суммирует факты/приросты по выбранным КМ | `summary = build_assignment_summary(assignments, True, logger, 'SUMMARY_TN')` |
| `process_project(project_root)` | Композиция всех шагов пайплайна | `process_project(Path.cwd())` |
| `main()` | Точка входа CLI | `python src/main.py` |

## 10. История версий
| Версия | Дата | Изменения |
|--------|------|-----------|
| 1.7.1 | 2025-11-26 | Обновлена документация: уточнены назначение листов `DETAIL_SCENARIO`/`SUMMARY_TN`, отражён режим `per_file`, добавлен раздел о выгрузке СПОД и описана связь `spod_variants` с whitelists `report_layout`. |
| 1.7.0 | 2025-11-26 | Переход на единый параметризуемый сценарий (`scenario`): выбираем ключ, учёт ТБ и режим назначения КМ. В Excel формируются только деталь, свод и процентиль выбранного сценария; остальные листы подключаются вручную через `report_layout`. |
| 1.6.0 | 2025-11-26 | Добавлен блок `report_layout`, который ограничивает содержимое Excel-файла (оставлены только RAW-листы, первоисточники `ID/ID_TB/ID_TN/ID_TB_TN`, промежуточные `TN_VKO/TN_VKO_TB` и выбранные листы СПОД). Остальные листы можно включать адресно через whitelists. |
| 1.5.0 | 2025-11-26 | Встроена методика процентных рангов (`Docs/percentile_logic.md`) для любых сценариев (`percentile_views`), реализована система `spod_variants` (отдельные настройки SPOD/CSV для каждой комбинации, свой набор листов в Excel, объединение нескольких сценариев в один CSV). Удалены глобальные настройки конкурса — теперь коды/дата/фильтры задаются в каждой записи `spod_variants`. |
| 1.4.0 | 2025-11-25 | Реализована полная матрица из 8 вариантов расчета приростов согласно методологии лаборатории режима. Все варианты сохраняются в Excel на отдельных листах, в CSV записывается только выбранная комбинация (параметр `csv_variant` в настройках `spod`). |
| 1.3.0 | 2025-11-25 | Добавлены настройки для учёта ТБ и режима назначения КМ в итогах/SPOD; реализованы листы `manager_views`, `direct_manager_views`, а также комбинации (например, `COMBO_VKO_NO_TB`). |
| 1.2.1 | 2025-11-25 | В Excel добавлены листы `RAW_T0/RAW_T1` с исходными данными и числовым `Факт (число)`; описаны новые функции форматирования. |
| 1.2.0 | 2025-11-25 | Полный переход на функциональный стиль: настройки сведены в вложенные структуры, классы логера/конфигов заменены на функции, добавлен фильтр и сортировка FACT_VALUE. |
| 1.1.0 | 2025-11-24 | Значения из `.env` перенесены напрямую в `src/main.py`, убрано чтение внешнего файла конфигурации. |
| 1.0.0 | 2025-11-24 | Создан репозиторий, реализован основной сценарий расчёта приростов, добавлены логирование, шаблон `.env`, структура каталогов и документация. |

## 11. Дополнительные материалы
- `Docs/percentile_logic.md` — подробная методика расчёта процентных рангов («обогнал»/«обогнали», глобально и внутри ТерБанка, с фильтром ≥0). Код и комментарии в `src/main.py` ссылаются на этот документ.
- `Docs/sheets_description.md` — полное описание всех листов Excel, создаваемых программой: назначение, колонки, логика расчёта, зависимости между листами и условия создания.
- `src/Tests/README.md` — инструкция по тестированию до появления автотестов.
- Прочие текстовые материалы (изначальное ТЗ и описание матрицы вариантов) полностью включены в этот README, поэтому отдельные файлы не требуются.

