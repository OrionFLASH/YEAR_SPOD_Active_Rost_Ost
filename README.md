# YEAR_SPOD_Active_Rost_Ost

## 1. Формулировка задачи и ТЗ

- Вся бизнес-логика должна находиться в единственном файле `src/main.py`. Используются только стандартные модули Python и базовый набор Anaconda 3.9 (`pandas`, `openpyxl` и пр.), установка дополнительных пакетов через `pip` запрещена.
- На вход поступают один, два или три XLSX-файла из каталога `IN`:
  - **Один файл** (режим `use_files_count="one"`): используется файл, указанный в `single_file.file_name`
    - Для каждого ТН считается количество строк (сделок) или максимальная сумма среди строк
  - **Два файла** (режим `use_files_count="two"`):
    - T-0: `АКТИВЫ 31-10-2025 (ОСТАТОК-V2).xlsx` (текущий период);
    - T-1: `АКТИВЫ 31-12-2024 (ОСТАТОК-V2).xlsx` (предыдущий период);
  - **Три файла** (режим `use_files_count="three"`):
    - T-0: `АКТИВЫ 31-10-2025 (ОСТАТОК-V2).xlsx` (текущий период);
    - T-1: `АКТИВЫ 31-12-2024 (ОСТАТОК-V2).xlsx` (предыдущий период);
    - T-2: `АКТИВЫ 30-09-2024 (ОСТАТОК-V2).xlsx` (опционально, для расчета с тремя периодами).
- Читается лист `Sheet1`, обязательные колонки и их бизнес-смысл:
  - `ТБ` — территориальный банк (строка);
  - `ГОСБ` — полное название ГОСБ (строка);
  - `ВКО` — ФИО клиентского менеджера (строка);
  - `Таб. номер ВКО` — табельный номер менеджера (строка фиксированной длины; длина и символ заполнения задаются параметрами);
  - `ИНН` — идентификатор клиента (строка фиксированной длины);
  - `Остаток срочной задолженности по основному долгу` — факт (число).
- Предварительная обработка:
  - строки с запрещёнными значениями удаляются (настройки задаются по колонкам);
  - текстовые поля нормализуются;
  - табельные номера и ИНН приводятся к заданной длине с лидирующими символами;
  - факт преобразуется к числовому типу с разделителем `,`.
- Ключевые требования по логике:
  - Рассчитать прирост для выбранного варианта расчета (variant_1, variant_2 или variant_3).
  - Сформировать свод по табельным номерам (`SUMMARY_TN`) с процентильными метриками.
  - Для вариантов по ИНН (variant_2, variant_3) создать свод по клиентам (`SUMMARY_INN`).
  - Построить выгрузку СПОД (Excel и CSV) с колонками `MANAGER_PERSON_NUMBER`, `CONTEST_CODE`, `TOURNAMENT_CODE`, `CONTEST_DATE`, `PLAN_VALUE`, `FACT_VALUE`, `priority_type`. Форматы чисел (`0.00000`) и длины (`20` символов для табельного номера) фиксированы.
- Требования к форматированию Excel:
  - Заголовок — жирный, перенос по строкам; строки с данными — перенос по словам.
  - Ширина столбцов ограничена диапазоном 70–200 символов и подбирается по содержимому.
  - Включены `freeze panes` (ячейка `A2`) и автофильтр на всём диапазоне.
  - Все листы автоматически сортируются от большего к меньшему значению по ключевой колонке.
- Имена файлов (`OUT` и `log`) содержат префикс из настроек и суффикс `_YYYYMMDD_HH_MM`.
- Логирование ведётся в двух файлах (INFO и DEBUG). INFO дублируется в консоль, DEBUG содержит полные сообщения вида `дата время - [DEBUG] - ... [class: ... | def: ...]`.

## 2. Методология расчёта

### 2.1 Варианты расчета прироста

Программа поддерживает три варианта расчета прироста, из которых выбирается один активный вариант для обработки:

#### Вариант 1: По КМ (manager_id), без учета ТБ
- **Ключ агрегации**: `manager_id` (табельный номер менеджера)
- **Учет ТБ**: Нет
- **Логика**: 
  - В каждом файле (T-0, T-1, T-2) суммируются факты по каждому табельному номеру менеджера
  - Прирост рассчитывается как разница между периодами
  - Каждый менеджер получает только свои собственные строки из исходных файлов

#### Вариант 2: По ИНН (client_id), без ТБ
- **Ключ агрегации**: `client_id` (ИНН клиента)
- **Учет ТБ**: Нет
- **Логика**:
  - В каждом файле суммируются факты по каждому ИНН
  - Для каждого ИНН определяется доминантный менеджер (с максимальной суммой факта) в каждом периоде
  - Выбирается "последний" менеджер: приоритет T-0, затем T-1, затем T-2 (если есть)
  - Все факты клиента привязываются к выбранному менеджеру
  - Прирост рассчитывается по формуле:
    - **Без T-2**: `Прирост = Факт_T0 - Факт_T1`
    - **С T-2**: `Прирост = (Факт_T0 - Факт_T1) - (Факт_T1 - Факт_T2) = Факт_T0 - 2*Факт_T1 + Факт_T2`

#### Вариант 3: По ИНН (client_id), с учетом ТБ
- **Ключ агрегации**: `client_id` (ИНН клиента) + `tb` (территориальный банк)
- **Учет ТБ**: Да
- **Логика**: Аналогично варианту 2, но агрегация и выбор менеджера происходят внутри каждого ТБ отдельно

### 2.2 Формулы расчета прироста

#### Без использования T-2 (два периода):
```
Прирост = Факт_T0 - Факт_T1
```

#### С использованием T-2 (три периода):
```
Прирост = (Факт_T0 - Факт_T1) - (Факт_T1 - Факт_T2)
        = Факт_T0 - 2*Факт_T1 + Факт_T2
```

Эта формула отражает изменение прироста между периодами: сначала вычисляется прирост T-0 относительно T-1, затем вычитается прирост T-1 относительно T-2, что показывает ускорение или замедление динамики.

**Важно**: Если клиент присутствует только в T-0 (T-1 = 0 и T-2 = 0), то прирост рассчитывается как:
```
Прирост = Факт_T0 - 2*0 + 0 = Факт_T0
```

То есть прирост равен значению факта в T-0. Перед расчетом прироста все отсутствующие значения (NaN) автоматически заполняются нулями.

### 2.3 Выбор активного варианта

Активный вариант задается в настройках `variants.active_variant` и может принимать значения:
- `"variant_1"` — расчет по КМ без ТБ
- `"variant_2"` — расчет по ИНН без ТБ
- `"variant_3"` — расчет по ИНН с ТБ

Только выбранный вариант рассчитывается и записывается в Excel. Это позволяет:
- Уменьшить время обработки
- Сократить размер выходного файла
- Сфокусироваться на нужном сценарии анализа

### 2.4 Процентильная аналитика

На базе свода по табельным номерам автоматически рассчитываются процентильные метрики:
- `Обогнал_всего_%` — процент менеджеров с меньшим приростом
- `Обогнали_меня_всего_%` — процент менеджеров с большим приростом
- `Обогнал_всего_кол` — количество менеджеров с меньшим приростом
- `Обогнали_меня_всего_кол` — количество менеджеров с большим приростом
- `Равных_всего_кол` — количество менеджеров с равным приростом
- `Всего_КМ_всего` — общее количество менеджеров в выборке для сравнения

**Настройки расчета процентилей** (в блоке `percentile_calculation`):
- **Тип процентиля** (`percentile_type`):
  - `"above"` — рассчитывается процент КМ с меньшим результатом (кого я обогнал, кто ниже меня)
  - `"below"` — рассчитывается процент КМ с большим результатом (кто меня обогнал, кто выше меня)
- **Уровень группировки** (`percentile_group_by`):
  - `"all"` — сравнение среди всех менеджеров
  - `"tb"` — сравнение только среди менеджеров с тем же ТБ
  - `"gosb"` — сравнение только среди менеджеров с тем же ГОСБ
  - `"tb_and_gosb"` — сравнение только среди менеджеров с тем же ТБ и ГОСБ одновременно
- **Фильтр данных** (`percentile_filter`):
  - `">=0"` — расчет только по неотрицательным значениям
  - `">0"` — расчет только по положительным значениям
  - `"all"` — расчет по всем значениям

**Независимый выбор варианта процентиля**:
- Параметр `active_percentile_variant` позволяет выбрать отдельный вариант для расчета процентиля, отличный от основного варианта расчета прироста (`active_variant`).
- Это позволяет, например, рассчитывать прирост по варианту 2 (без ТБ), а процентили — по варианту 3 (с ТБ, группировка по ТБ).

**Формула процентиля**:
```
Обогнал_% = (количество менеджеров с меньшим значением) / (общее количество в группе) * 100
Обогнали_меня_% = (количество менеджеров с большим значением) / (общее количество в группе) * 100
```

### 2.5 Выгрузка СПОД

Система СПОД (Система Планирования и Отчетности Данных) получает данные в стандартизированном формате:
- `MANAGER_PERSON_NUMBER` — табельный номер (20 символов, заполнение нулями слева)
- `CONTEST_CODE` — код конкурса
- `TOURNAMENT_CODE` — код турнира
- `CONTEST_DATE` — дата конкурса (формат ISO: YYYY-MM-DD)
- `PLAN_VALUE` — плановое значение (формат: 0.00000)
- `FACT_VALUE` — фактическое значение (формат: 0.00000)
- `priority_type` — приоритет (целое число, по умолчанию 1)

Поддерживаются два варианта выгрузки СПОД:
1. **SPOD_SCENARIO** — на основе колонки "Прирост" из `SUMMARY_TN`
2. **SPOD_SCENARIO_PERCENTILE** — на основе колонки "Обогнал_всего_%" из процентильных данных

Каждый вариант может иметь свой фильтр (`fact_value_filter`) для отбора данных и настройки включения в CSV (`include_in_csv`).

## 3. Описание решения

- Вся бизнес-логика реализована в одном файле `src/main.py` и использует только стандартную библиотеку Python плюс `pandas` и `openpyxl`.
- Выбирается один активный вариант расчета из трех возможных (`variant_1`, `variant_2`, `variant_3`).
- После очистки исходных файлов формируется набор данных для выбранного варианта, далее — свод по табельным номерам с процентилями и (для вариантов 2 и 3) свод по ИНН.
- Все числовые поля форматируются средствами `openpyxl`.
- Выгрузка СПОД (Excel и CSV) конфигурируется в `spod.variants`. По умолчанию экспортируются два варианта: основной и процентильный.
- В книгу попадают листы согласно `report_layout`: `SUMMARY_TN`, `SUMMARY_INN` (для вариантов 2 и 3), `SPOD_SCENARIO`, `SPOD_SCENARIO_PERCENTILE`, `RAW_T0`, `RAW_T1`, `RAW_T2` (если используется).
- Все листы автоматически сортируются от большего к меньшему значению по ключевой колонке.
- Логи ведутся раздельно для уровней INFO/DEBUG в каталоге `log`, INFO дополнительно выводится в консоль.

## 4. Структура каталогов

```
YEAR_SPOD_Active_Rost_Ost/
├── Docs/               # Папка для дополнительных материалов
│   ├── percentile_logic.md    # Подробная методика расчета процентилей
│   └── sheets_description.md   # Описание листов Excel (устаревшая версия)
├── IN/                 # Входные XLSX-файлы (T-0, T-1, T-2)
├── OUT/                # Итоговые Excel и CSV файлы
├── log/                # Логи INFO/DEBUG
├── src/
│   ├── main.py         # Основной скрипт
│   └── Tests/
│       └── README.md   # Состояние автотестов
└── README.md           # Текущая документация (включает полное ТЗ и методологию)
```

## 5. Настройка окружения

1. Создать и активировать виртуальное окружение:
   ```bash
   cd ~/Desktop/MyProject/YEAR_SPOD_Active_Rost_Ost
   python3 -m venv .venv
   source .venv/bin/activate
   ```
2. Установки через `pip` не требуются (используется базовый набор Anaconda / стандартная библиотека).
3. (Опционально) Скопировать `.env.example` в `.env`, если планируется возвращение к внешней конфигурации. По умолчанию все параметры уже прошиты в `src/main.py` и сведены в дерево настроек.

## 6. Конфигурация

Вся настройка сведена в одну структуру, которую формирует функция `build_settings_tree()`:

### 6.1 `files` — описание входных XLSX
- `items` (`current`/`previous`/`previous2`): имя файла в `IN`, метка периода и лист
  - Каждый элемент может содержать:
    - `columns`: маппинг alias ↔ оригинальный заголовок в Excel для этого файла
      - Если пустой массив `[]`, используются значения из `defaults.columns`
    - `filters.drop_rules`: правила фильтрации для этого файла
      - Если пустой массив `[]`, используются значения из `defaults.drop_rules`
- `sheet`: имя листа по умолчанию

### 6.2 `defaults` — настройки по умолчанию
- `manager_name`: ФИО менеджера по умолчанию ("Не найден КМ")
- `manager_id`: табельный номер по умолчанию ("90000009")
- `columns`: общие колонки по умолчанию (используются, если в items для файла columns пустой массив)
  - Список словарей с `alias` и `source`
  - Если в items для файла `columns` пустой массив `[]`, используются значения из `defaults.columns`
- `drop_rules`: общие правила фильтрации по умолчанию (используются, если в items для файла filters.drop_rules пустой массив)
  - Список правил для удаления строк с запрещенными значениями по колонкам
  - Каждое правило содержит:
    - `alias`: имя колонки (должно совпадать с alias из columns)
    - `values`: список запрещенных значений
    - `remove_unconditionally` (bool, по умолчанию `True`): удалять ли строки всегда
      - `True`: удаляем строки с запрещенными значениями (с учетом условий, если они заданы)
      - `False`: НЕ удаляем строки вообще, правило игнорируется
    - `check_by_inn` (bool, по умолчанию `False`): проверять ли по ИНН перед удалением
      - `True`: если по этому ИНН есть другие строки с НЕзапрещенными значениями в этой колонке → строка НЕ удаляется
      - `False`: проверка по ИНН не выполняется
    - `check_by_tn` (bool, по умолчанию `False`): проверять ли по ТН перед удалением
      - `True`: если по этому ТН есть другие строки с НЕзапрещенными значениями в этой колонке → строка НЕ удаляется
      - `False`: проверка по ТН не выполняется
  - Если в items для файла `filters.drop_rules` пустой массив `[]`, используются значения из `defaults.drop_rules`
  - Если оба `check_by_inn=True` и `check_by_tn=True` → работает как ИЛИ (если хотя бы одно условие выполняется, не удаляем)

### 6.4 `identifiers` — форматирование идентификаторов
- `manager_id`: настройки форматирования табельного номера (длина, символ заполнения)
- `client_id`: настройки форматирования ИНН (длина, символ заполнения)

### 6.5 `spod` — настройки выгрузки СПОД
- `file_prefix`: префикс имен Excel/CSV файлов
- `log_topic`: тема для логов
- `variants`: список вариантов выгрузки СПОД, каждый содержит:
  - `name`: имя варианта (используется как имя листа)
  - `calc_sheet_name`: имя расчетного листа (не используется, оставлено для совместимости)
  - `source_type`: тип источника (`"scenario_summary"` или `"scenario_percentile"`)
  - `value_column`: колонка со значениями для выгрузки (используется для фильтрации и сортировки)
  - `fact_value_filter`: фильтр для отбора данных (`">0"`, `">=0"`, `"all"` и т.д.)
  - `plan_value`: плановое значение (float)
  - `priority`: приоритет (int, по умолчанию 1)
  - `contest_code`: код конкурса
  - `tournament_code`: код турнира
  - `contest_date`: дата конкурса (формат DD/MM/YYYY)
  - `include_in_csv`: включить ли в CSV выгрузку (bool)
  
  **Примечание**: Для вариантов с `source_type="scenario_percentile"` колонка для `FACT_VALUE` определяется автоматически на основе `percentile_type` из настроек процентиля (`percentile_calculation.percentile_type`):
  - Если `percentile_type="above"` → `FACT_VALUE = Обогнал_всего_%`
  - Если `percentile_type="below"` → `FACT_VALUE = Обогнали_меня_всего_%`

### 6.6 `main_calculation` — параметры основного расчета прироста

- `use_files_count`: количество файлов для расчета (текстовые значения)
  - `"one"` — расчет по одному файлу (требуется настройка `single_file`)
    - Для каждого ТН считается количество строк (сделок) или максимальная сумма среди строк
    - Не требует наличия файлов `current` и `previous`
  - `"two"` — расчет по двум файлам (T-0 и T-1), требуется наличие `current` и `previous`
  - `"three"` — расчет по трем файлам (T-0, T-1 и T-2), требуется наличие `current`, `previous` и `previous2`
  - Если необходимый файл отсутствует, программа выводит ошибку в консоль и лог и прекращает выполнение
- `key_mode`: режим агрегации данных (только для `"two"` и `"three"`)
  - `"manager"` — агрегация по manager_id (табельному номеру), суммируем в каждом файле по КМ, затем разница
  - `"client"` — агрегация по client_id (ИНН), КМ определяется на конец периода (T-0 → T-1 → T-2)
- `include_tb`: учитывать ли ТБ при расчете (только для `key_mode="client"` и `use_files_count="two"/"three"`)
  - `True` — расчет с учетом ТБ (клиент привязан к КМ в рамках ТБ)
  - `False` — расчет без учета ТБ (клиент привязан к КМ глобально)
- `single_file`: настройки для расчета по одному файлу (только для `use_files_count="one"`)
  - `file_name`: имя файла в каталоге IN (например, `"2025_M-10_DIF.xlsx"`)
  - `sheet`: имя листа в файле (по умолчанию `"Sheet1"`)
  - `calculation_type`: тип расчета для одного файла
    - `"count"` — количество строк (сделок) для каждого ТН
    - `"max"` — максимальная сумма среди строк для каждого КМ
  - `columns`: колонки для этого файла (если пустой массив `[]`, используются из `defaults.columns`)
  - `filters`: фильтры для этого файла
    - `drop_rules`: правила удаления строк (если пустой массив `[]`, используются из `defaults.drop_rules`)
    - `in_rules`: правила включения строк (что ДОЛЖНО попасть в расчет)
      - Строка попадает в расчет только если она проходит ВСЕ условия из `in_rules` (И)
      - И при этом НЕ попадает под `drop_rules` (исключается из DROP)
      - Формат: `{"alias": "имя_колонки", "values": ["значение1", "значение2"], "condition": "in" или "not_in"}`
      - `"in"`: значение должно быть в списке `values`
      - `"not_in"`: значение НЕ должно быть в списке `values`

### 6.7 `percentile_calculation` — параметры расчета процентиля
- `percentile_type`: тип процентиля
  - `"above"` — рассчитывается процент КМ с меньшим результатом (кого я обогнал, кто ниже меня)
  - `"below"` — рассчитывается процент КМ с большим результатом (кто меня обогнал, кто выше меня)
- `percentile_group_by`: уровень группировки для расчета процентиля
  - `"all"` — сравнение среди всех КМ
  - `"tb"` — сравнение только среди КМ с тем же ТБ
  - `"gosb"` — сравнение только среди КМ с тем же ГОСБ
  - `"tb_and_gosb"` — сравнение только среди КМ с тем же ТБ и ГОСБ одновременно
- `percentile_filter`: фильтр для данных при расчете процентилей
  - `">=0"` — расчет только по неотрицательным значениям
  - `">0"` — расчет только по положительным значениям
  - `"all"` — расчет по всем значениям

### 6.8 `excel_formatting` — параметры форматирования Excel
- `column_width`: настройки ширины колонок
  - `min_width`: минимальная ширина колонки в пунктах (по умолчанию 20)
  - `max_width`: максимальная ширина колонки в пунктах (по умолчанию 200)
  - `auto_fit`: автоматическая подстройка ширины по содержимому (по умолчанию True)
- `wrap_text`: включить перенос текста по строкам для всех ячеек (по умолчанию True)
  - `True` — текст переносится на новые строки, если не помещается в ячейку
  - `False` — текст не переносится

**Примечание**: Ширина колонок автоматически подстраивается по содержимому (заголовок + данные) с учетом ограничений `min_width` и `max_width`. Если содержимое не помещается в ячейку, включается перенос текста (`wrap_text=True`).

### 6.9 `report_layout` — управление выводом листов
- `summary_sheets`: список листов сводов (по умолчанию `["SUMMARY_TN", "SUMMARY_INN"]`)
- `percentile_sheets`: список листов процентилей (по умолчанию пустой, процентили включены в `SUMMARY_TN`)
- `calc_sheets`: список расчетных листов (по умолчанию пустой, не используются)
- `spod_variants`: список вариантов СПОД для вывода (по умолчанию `["SPOD_SCENARIO", "SPOD_SCENARIO_PERCENTILE"]`)
- `raw_sheets`: список исходных листов (по умолчанию `["RAW_T0", "RAW_T1", "RAW_T2"]`)

Если ключ отсутствует в `report_layout` или равен `None`, все листы блока выводятся. Если список пуст, блок отключается.

## 7. Использование

1. Поместите исходные файлы в каталог `IN` под именами:
   - `АКТИВЫ 31-10-2025 (ОСТАТОК-V2).xlsx` (T-0)
   - `АКТИВЫ 31-12-2024 (ОСТАТОК-V2).xlsx` (T-1)
   - `АКТИВЫ 30-09-2024 (ОСТАТОК-V2).xlsx` (T-2, опционально)
2. Запустите скрипт:
   ```bash
   python src/main.py
   ```
3. Результаты появятся в каталоге `OUT` в виде Excel и CSV файлов с суффиксом `_YYYYMMDD_HH_MM`.

## 8. Описание листов Excel

### 8.1 `SUMMARY_TN` — Свод по табельным номерам

**Колонки для варианта с двумя файлами (use_files_count="two")**:
- `Таб. номер ВКО (выбранный)` — табельный номер менеджера
- `ВКО (выбранный)` — ФИО менеджера
- `ТБ` — территориальный банк
- `ГОСБ` — полное название ГОСБ
- `Факт_T0` — сумма факта в периоде T-0
- `Факт_T1` — сумма факта в периоде T-1
- `Прирост` — рассчитанный прирост (Факт_T0 - Факт_T1)
- Процентильные колонки (если включены)

**Колонки для варианта с тремя файлами (use_files_count="three")**:
- `Таб. номер ВКО (выбранный)` — табельный номер менеджера
- `ВКО (выбранный)` — ФИО менеджера
- `ТБ` — территориальный банк
- `ГОСБ` — полное название ГОСБ
- `Факт_T0` — сумма факта в периоде T-0
- `Факт_T1` — сумма факта в периоде T-1
- `Факт_T2` — сумма факта в периоде T-2
- `Прирост` — рассчитанный прирост (Факт_T0 - 2*Факт_T1 + Факт_T2)
- Процентильные колонки (если включены)

**Примечание**: Колонка `Факт_T2` добавляется автоматически только для варианта с тремя файлами.

**Назначение**: Агрегированные итоги по выбранным менеджерам с процентильными метриками.

**Источник данных**: Результат расчета выбранного активного варианта, объединенный с процентильными колонками.

**Колонки**:
- `Таб. номер ВКО (выбранный)` — табельный номер менеджера
- `ВКО (выбранный)` — ФИО менеджера
- `ТБ` — территориальный банк (добавляется для справки)
- `ГОСБ` — полное название ГОСБ (добавляется для справки)
- `Факт_T0` — сумма фактов T-0 по всем записям менеджера
- `Факт_T1` — сумма фактов T-1 по всем записям менеджера
- `Факт_T2` — сумма фактов T-2 по всем записям менеджера (если используется T-2)
- `Прирост` — итоговый прирост менеджера
- `Количество записей` — число детальных строк, попавших в агрегат (для варианта 1)
- **Процентильные метрики**:
  - `Обогнал_всего_%` — процент менеджеров с меньшим приростом
  - `Обогнали_меня_всего_%` — процент менеджеров с большим приростом
  - `Обогнал_всего_кол` — количество менеджеров с меньшим приростом
  - `Обогнали_меня_всего_кол` — количество менеджеров с большим приростом
  - `Равных_всего_кол` — количество менеджеров с равным приростом
  - `Всего_КМ_всего` — общее количество менеджеров в выборке

**Сортировка**: По колонке "Прирост" от большего к меньшему.

**Форматирование**: 
- Числовые колонки (факты, прирост, процентили) — формат `#,##0.00` (разделитель тысяч, 2 знака после запятой)
- Колонки с количеством — формат `#,##0` (целые числа с разделителем тысяч)

### 8.2 `SUMMARY_INN` — Свод по ИНН (только для вариантов 2 и 3)

**Назначение**: Детальная информация по клиентам с фактами по каждому периоду и итоговым приростом.

**Источник данных**: Данные варианта до агрегации, объединенные с суммами фактов по каждому периоду.

**Колонки**:
- `ИНН` — идентификатор клиента
- `Кол-во ТН_T0` — количество разных табельных номеров, связанных с клиентом в T-0
- `ТН_T0` — выбранный табельный номер менеджера в T-0
- `Факт_T0` — сумма фактов по клиенту в T-0 (формат: `#,##0.00`)
- `Кол-во ТН_T1` — количество разных табельных номеров, связанных с клиентом в T-1
- `ТН_T1` — выбранный табельный номер менеджера в T-1
- `Факт_T1` — сумма фактов по клиенту в T-1 (формат: `#,##0.00`)
- `Кол-во ТН_T2` — количество разных табельных номеров, связанных с клиентом в T-2 (если используется T-2)
- `ТН_T2` — выбранный табельный номер менеджера в T-2 (если используется T-2)
- `Факт_T2` — сумма фактов по клиенту в T-2 (формат: `#,##0.00`, если используется T-2)
- `Прирост` — итоговый прирост по клиенту (формат: `#,##0.00`)
  - Без T-2: `Прирост = Факт_T0 - Факт_T1`
  - С T-2: `Прирост = (Факт_T0 - Факт_T1) - (Факт_T1 - Факт_T2) = Факт_T0 - 2*Факт_T1 + Факт_T2`
- `Итоговый ТН` — табельный номер менеджера, выбранного как "последний" (T-0 → T-1 → T-2)
- `ФИО КМ` — ФИО итогового менеджера
- `ТБ` — территориальный банк итогового менеджера

**Сортировка**: По колонке "Прирост" от большего к меньшему.

**Форматирование**: 
- Все числовые колонки (факты, прирост) — формат `#,##0.00` (разделитель тысяч, 2 знака после запятой)
- Колонки с количеством ТН — целые числа

### 8.3 `SPOD_SCENARIO` — Выгрузка СПОД для основного сценария

**Назначение**: Данные для загрузки в систему СПОД на основе колонки "Прирост" из `SUMMARY_TN`.

**Источник данных**: `SUMMARY_TN` (через `source_type="scenario_summary"`).

**Колонки** (стандартный формат СПОД + дополнительные для Excel):
- `MANAGER_PERSON_NUMBER` — табельный номер менеджера (20 символов, заполнение нулями слева)
- `CONTEST_CODE` — код конкурса
- `TOURNAMENT_CODE` — код турнира
- `CONTEST_DATE` — дата конкурса в формате ISO (YYYY-MM-DD)
- `PLAN_VALUE` — плановое значение (формат: 0.00000)
- `FACT_VALUE` — фактическое значение (колонка "Прирост" из источника, формат: 0.00000)
- `priority_type` — приоритет (целое число)
- **Дополнительные колонки (только в Excel, не в CSV)**:
  - `Факт` — значение "Прирост" в числовом формате (формат: `#,##0.00`)
  - `ФИО КМ` — ФИО менеджера
  - `ТБ` — территориальный банк
  - `ГОСБ` — полное название ГОСБ
  - `Кол-во ИНН` — количество уникальных ИНН, собранных на данном табельном номере

**Фильтр**: Применяется `fact_value_filter` из настроек (по умолчанию `">0"` — только положительные приросты).

**Сортировка**: По колонке "Факт" от большего к меньшему.

**Форматирование**: 
- `FACT_VALUE`, `PLAN_VALUE` — формат `0.00000` (5 знаков после запятой)
- `Факт` — формат `#,##0.00` (разделитель тысяч, 2 знака после запятой)
- `Кол-во ИНН` — целое число

### 8.4 `SPOD_SCENARIO_PERCENTILE` — Выгрузка СПОД для процентилей

**Назначение**: Данные для загрузки в систему СПОД на основе процентильных метрик.

**Источник данных**: `SUMMARY_TN` с процентильными колонками (через `source_type="scenario_percentile"`).

**Колонки** (стандартный формат СПОД + дополнительные для Excel):
- `MANAGER_PERSON_NUMBER` — табельный номер менеджера (20 символов, заполнение нулями слева)
- `CONTEST_CODE` — код конкурса
- `TOURNAMENT_CODE` — код турнира
- `CONTEST_DATE` — дата конкурса в формате ISO (YYYY-MM-DD)
- `PLAN_VALUE` — плановое значение (формат: 0.00000)
- `FACT_VALUE` — фактическое значение (колонка "Обогнал_всего_%" из источника, формат: 0.00000)
- `priority_type` — приоритет (целое число)
- **Дополнительные колонки (только в Excel, не в CSV)**:
  - `Факт` — значение "Обогнал_всего_%" в числовом формате (формат: `#,##0.00`)
  - `ФИО КМ` — ФИО менеджера
  - `ТБ` — территориальный банк
  - `ГОСБ` — полное название ГОСБ
  - `Кол-во ИНН` — количество уникальных ИНН, собранных на данном табельном номере
  - `Обогнал_всего_кол` — количество менеджеров с меньшим приростом
  - `Обогнали_меня_всего_кол` — количество менеджеров с большим приростом
  - `Равных_всего_кол` — количество менеджеров с равным приростом
  - `Всего_КМ_всего` — общее количество менеджеров в выборке

**Фильтр**: Применяется `fact_value_filter` из настроек (по умолчанию `">=0"` — все неотрицательные процентили).

**Сортировка**: По колонке "Факт" от большего к меньшему.

**Форматирование**: 
- `FACT_VALUE`, `PLAN_VALUE` — формат `0.00000` (5 знаков после запятой)
- `Факт` — формат `#,##0.00` (разделитель тысяч, 2 знака после запятой)
- Колонки с количеством — целые числа

### 8.5 `RAW_T0`, `RAW_T1`, `RAW_T2` — Очищенные исходные данные

**Назначение**: Исходные данные из файлов после очистки и нормализации, без агрегации.

**Источник данных**: Результат `read_source_file()` для соответствующего файла.

**Колонки** (русские названия):
- `Короткое ТБ` (tb)
- `Полное ГОСБ` (gosb)
- `ФИО` (manager_name)
- `Табельный номер` (manager_id)
- `ИНН` (client_id)
- `Факт` (fact_value) — исходное значение
- `Факт (число)` (fact_value_clean) — преобразованное в число значение

**Сортировка**: По колонке "Факт (число)" от большего к меньшему.

**Логика обработки**:
1. Чтение Excel-файла, переименование колонок по маппингу
2. Удаление строк с запрещенными значениями
3. Нормализация строковых полей
4. Форматирование идентификаторов: табельный номер до 8 символов, ИНН до 12 символов, заполнение нулями
5. Преобразование факта в число: замена запятой на точку, приведение к `float`

## 9. CSV-файл

### `YEAR_SPOD_Active_Rost_ost_SPOD_YYYYMMDD_HH_MM.csv`

**Назначение**: Объединённая выгрузка всех вариантов СПОД, где `include_in_csv=True`, для загрузки в систему.

**Источник данных**: Объединение всех `spod_dataset`, где `spod_variants[i].include_in_csv=True`.

**Колонки**: Стандартный формат СПОД (без дополнительных колонок из Excel):
- `MANAGER_PERSON_NUMBER`
- `CONTEST_CODE`
- `TOURNAMENT_CODE`
- `CONTEST_DATE`
- `PLAN_VALUE`
- `FACT_VALUE`
- `priority_type`

**Логика**:
- Все DataFrame из `csv_frames` объединяются через `pd.concat()`
- Разделитель: точка с запятой (`;`)
- Квотирование: минимальное (только при необходимости)
- Кодировка: UTF-8 с BOM для корректного отображения в Excel

**Условие создания**: CSV создаётся только если есть хотя бы один вариант с `include_in_csv=True`.

## 10. Логирование

- **INFO**: ключевые этапы обработки, пишутся в файл `INFO_<topic>_<timestamp>.log` и дублируются в консоль.
- **DEBUG**: подробные сообщения для каждой функции с указанием класса и имени функции, записываются в `DEBUG_<topic>_<timestamp>.log`.
- **Формат DEBUG строки**: `YYYY-MM-DD HH:MM:SS - [DEBUG] - Сообщение [class: <...> | def: <...>]`.
- При возникновении исключений основной сценарий фиксирует сообщение в INFO и полную трассировку (в одну строку) в DEBUG, после чего пробрасывает ошибку наружу.

## 11. Список функций и примеры использования

| Функция / структура | Назначение | Пример вызова |
|--------------------|-----------|---------------|
| `build_settings_tree()` | Возвращает полную вложенную структуру настроек | `settings = build_settings_tree()` |
| `build_column_profiles(columns)` | Строит маппинг alias↔оригинал | `profiles = build_column_profiles(settings['files']['columns'])` |
| `build_drop_rules(rules)` | Преобразует список правил фильтрации к словарю с параметрами условного удаления | `rules = build_drop_rules(settings['defaults']['drop_rules'])` |
| `get_file_meta(file_section, key)` | Возвращает описание нужного Excel | `current = get_file_meta(settings['files'], 'current')` |
| `resolve_sheet_name(file_section, key)` | Определяет имя листа файла | `sheet = resolve_sheet_name(settings['files'], 'current')` |
| `parse_contest_date(date_str)` | Переводит дату турнира `DD/MM/YYYY` к ISO | `iso = parse_contest_date('31/10/2025')` |
| `build_filter_mask(series, condition)` | Формирует маску для фильтра `FACT_VALUE` | `mask = build_filter_mask(df['Прирост'], '>=0')` |
| `ensure_directories(paths)` | Создаёт недостающие каталоги | `ensure_directories([Path('IN')])` |
| `timestamp_suffix()` | Возвращает строку `_YYYYMMDD_HH_MM` | `suffix = timestamp_suffix()` |
| `format_identifier(value, length, char)` | Форматирует идентификаторы с лидирующими символами | `format_identifier('85461', 8, '0') -> '00085461'` |
| `safe_to_float(value)` | Безопасно приводит строку к `float` | `safe_to_float('43,51') -> 43.51` |
| `normalize_string(value)` | Очищает текстовое поле | `normalize_string('  ABC ') -> 'ABC'` |
| `build_logger(log_dir, topic)` | Возвращает функции `info`/`debug` | `logger = build_logger(Path('log'), 'spod')` |
| `log_info(logger, message)` | Записывает INFO без классов | `log_info(logger, 'Старт обработки')` |
| `log_debug(logger, message, class, func)` | Записывает DEBUG | `log_debug(logger, '...', 'Cleaner', 'drop_forbidden_rows')` |
| `DataLoader.read_source_file(...)` | Загружает Excel, нормализует данные | `df = data_loader.read_source_file(file_path, 'Sheet1', rename_map, rules)` |
| `Aggregator.aggregate_facts(...)` | Суммирует факт по ключу | `agg = aggregator.aggregate_facts(df, ['client_id'], 'T0', 'ID')` |
| `Aggregator.select_best_manager(...)` | Определяет менеджера с максимальным фактом | `best = aggregator.select_best_manager(df, ['client_id'], 'ID')` |
| `Aggregator.build_latest_manager(...)` | Комбинирует актуального менеджера | `latest = aggregator.build_latest_manager(curr, prev, ['client_id'], 'ID')` |
| `calculate_variant_1(...)` | Рассчитывает вариант 1 (по КМ, без ТБ) | `summary = calculate_variant_1(current_df, previous_df, previous2_df, defaults, identifiers, logger)` |
| `calculate_variant_2(...)` | Рассчитывает вариант 2 (по ИНН, без ТБ) | `summary = calculate_variant_2(current_df, previous_df, previous2_df, defaults, identifiers, logger)` |
| `calculate_variant_3(...)` | Рассчитывает вариант 3 (по ИНН, с ТБ) | `summary = calculate_variant_3(current_df, previous_df, previous2_df, defaults, identifiers, logger)` |
| `build_client_summary_by_inn(...)` | Строит свод по ИНН | `client_summary = build_client_summary_by_inn(variant_df, current_df, previous_df, previous2_df, manager_tb_mapping, manager_gosb_mapping, defaults, identifiers, logger)` |
| `PercentileCalculator.append_percentile_columns(...)` | Добавляет процентильные колонки | `augmented = percentile_calc.append_percentile_columns(summary, value_column='Прирост', tb_column='ТБ', percentile_filter='>=0')` |
| `build_spod_dataset(...)` | Создаёт таблицу SPOD для конкретного сценария | `spod = build_spod_dataset(source_table, value_column='Прирост', fact_value_filter='>0', plan_value=0.0, priority=1, contest_code='...', tournament_code='...', contest_date='31/10/2025', identifiers=identifiers, logger=logger, dataset_name='SPOD_V7')` |
| `build_spod_dataset_for_excel(...)` | Создаёт расширенный SPOD датасет для Excel | `spod_excel = build_spod_dataset_for_excel(source_table, filtered_table, spod_dataset, value_column, source_type, manager_tb_mapping, manager_gosb_mapping, variant_df_for_client_summary, current_df, previous_df, identifiers, logger)` |
| `format_raw_sheet(df, alias_map)` | Подготавливает листы `RAW_T0/RAW_T1/RAW_T2` | `raw = format_raw_sheet(current_df, profiles['alias_to_source'])` |
| `ExcelExporter.write_sheet(...)` | Записывает DataFrame в лист Excel с форматированием | `excel_exporter.write_sheet(writer, 'SUMMARY_TN', df, written_sheets)` |
| `ExcelExporter.format_sheet(...)` | Применяет форматирование листа Excel | `ExcelExporter.format_sheet(writer, 'SUMMARY_TN', df)` |
| `process_project(project_root)` | Композиция всех шагов пайплайна | `process_project(Path.cwd())` |
| `main()` | Точка входа CLI | `python src/main.py` |

## 12. История версий

| Версия | Дата | Изменения |
|--------|------|-----------|
| 2.3.0 | 2025-12-01 | Добавлена поддержка расчета по одному файлу (`use_files_count="one"`): два типа расчета - количество строк (сделок) для каждого ТН (`calculation_type="count"`) и максимальная сумма среди строк для каждого КМ (`calculation_type="max"`). Параметр `use_files_count` изменен с числовых значений (2, 3) на текстовые ("one", "two", "three"). Добавлен параметр `in_rules` для фильтрации включения строк (что ДОЛЖНО попасть в расчет): строка попадает в расчет только если она проходит ВСЕ условия из `in_rules` (И) и при этом НЕ попадает под `drop_rules`. Добавлен блок `single_file` в `main_calculation` с настройками для одного файла (file_name, sheet, calculation_type, columns, filters с in_rules). Созданы функции `calculate_single_file_count` и `calculate_single_file_max` для расчета по одному файлу. Обновлена логика проверки файлов и загрузки данных для поддержки одного файла. |
| 2.2.0 | 2025-12-01 | Добавлена гибкая система расчета процентилей с параметрами в вариантах расчета: `percentile_type` (кого я обогнал / кто меня обогнал), `percentile_group_by` (среди всех / по ТБ / по ГОСБ / по ТБ и ГОСБ), `percentile_filter` (фильтр данных). Добавлен параметр `active_percentile_variant` для независимого выбора варианта расчета процентиля. Параметр `percentile_filter` перенесен из `spod` в `variants`. Обновлена функция `append_percentile_columns` для поддержки группировки по ТБ и/или ГОСБ. |
| 2.1.0 | 2025-12-01 | Добавлена поддержка условного удаления строк в `drop_rules`: параметры `remove_unconditionally`, `check_by_inn`, `check_by_tn`. Настройки `columns` и `drop_rules` перенесены в блок `defaults`. Реализована логика использования значений по умолчанию: если в items для файла `columns` или `filters.drop_rules` пустые массивы, используются значения из `defaults`. Добавлена возможность выбора колонки процентиля для FACT_VALUE в SPOD через параметр `percentile_value_type`. |
| 2.1.0 | 2025-12-02 | Добавлена колонка `Факт_T2` в лист `SUMMARY_TN` для варианта с тремя файлами. Исправлена логика определения итогового ТН и КМ: теперь используется приоритет T-0 → T-1 → T-2 (для трех файлов) или T-0 → T-1 (для двух файлов), значение по умолчанию применяется только если менеджер не найден ни в одном из периодов. Исправлен расчет прироста для случая, когда клиент присутствует только в T-0: прирост = Факт_T0. Перед расчетом прироста все отсутствующие значения (NaN) автоматически заполняются нулями. |
| 2.0.0 | 2025-12-01 | Добавлена автоматическая сортировка всех листов от большего к меньшему значению. Доработан лист SUMMARY_INN: добавлены факты по каждому периоду (Факт_T0, Факт_T1, Факт_T2) и итоговый прирост. Исправлена формула расчета прироста с T-2: `Прирост = (Факт_T0 - Факт_T1) - (Факт_T1 - Факт_T2) = Факт_T0 - 2*Факт_T1 + Факт_T2`. Обновлена документация с подробным описанием всех расчетов, листов и переменных. |
| 1.8.0 | 2025-12-01 | Упрощены процентильные расчеты: удалены метрики с фильтром `_≥0_%` и все метрики по ТерБанку. Оставлены только глобальные метрики: `Обогнал_всего_%`, `Обогнали_меня_всего_%`, `Обогнал_всего_кол`, `Обогнали_меня_всего_кол`, `Равных_всего_кол`, `Всего_КМ_всего`. Разделены параметры фильтрации для расчета процентилей (`percentile_filter`) и для вывода в SPOD (`fact_value_filter`). |
| 1.7.2 | 2025-11-28 | Объединены листы SUMMARY_TN и PERCENTILE_TN в один лист SUMMARY_TN. Добавлен лист SUMMARY_INN для вариантов 2 и 3 с детальной информацией по клиентам. Добавлены дополнительные колонки в SPOD листы Excel (Факт, ФИО КМ, ТБ, ГОСБ, Кол-во ИНН, процентильные счетчики для SPOD_SCENARIO_PERCENTILE). CSV выгрузка остается без дополнительных колонок. Удалены листы CALC_SCENARIO и CALC_SCENARIO_PERC. |
| 1.7.1 | 2025-11-26 | Обновлена документация: уточнены назначение листов `DETAIL_SCENARIO`/`SUMMARY_TN`, отражён режим `per_file`, добавлен раздел о выгрузке СПОД и описана связь `spod_variants` с whitelists `report_layout`. |
| 1.7.0 | 2025-11-26 | Переход на единый параметризуемый сценарий (`scenario`): выбираем ключ, учёт ТБ и режим назначения КМ. В Excel формируются только деталь, свод и процентиль выбранного сценария; остальные листы подключаются вручную через `report_layout`. |
| 1.6.0 | 2025-11-26 | Добавлен блок `report_layout`, который ограничивает содержимое Excel-файла (оставлены только RAW-листы, первоисточники `ID/ID_TB/ID_TN/ID_TB_TN`, промежуточные `TN_VKO/TN_VKO_TB` и выбранные листы СПОД). Остальные листы можно включать адресно через whitelists. |
| 1.5.0 | 2025-11-26 | Встроена методика процентных рангов (`Docs/percentile_logic.md`) для любых сценариев (`percentile_views`), реализована система `spod_variants` (отдельные настройки SPOD/CSV для каждой комбинации, свой набор листов в Excel, объединение нескольких сценариев в один CSV). Удалены глобальные настройки конкурса — теперь коды/дата/фильтры задаются в каждой записи `spod_variants`. |
| 1.4.0 | 2025-11-25 | Реализована полная матрица из 8 вариантов расчета приростов согласно методологии лаборатории режима. Все варианты сохраняются в Excel на отдельных листах, в CSV записывается только выбранная комбинация (параметр `csv_variant` в настройках `spod`). |
| 1.3.0 | 2025-11-25 | Добавлены настройки для учёта ТБ и режима назначения КМ в итогах/SPOD; реализованы листы `manager_views`, `direct_manager_views`, а также комбинации (например, `COMBO_VKO_NO_TB`). |
| 1.2.1 | 2025-11-25 | В Excel добавлены листы `RAW_T0/RAW_T1` с исходными данными и числовым `Факт (число)`; описаны новые функции форматирования. |
| 1.2.0 | 2025-11-25 | Полный переход на функциональный стиль: настройки сведены в вложенные структуры, классы логера/конфигов заменены на функции, добавлен фильтр и сортировка FACT_VALUE. |
| 1.1.0 | 2025-11-24 | Значения из `.env` перенесены напрямую в `src/main.py`, убрано чтение внешнего файла конфигурации. |
| 1.0.0 | 2025-11-24 | Создан репозиторий, реализован основной сценарий расчёта приростов, добавлены логирование, шаблон `.env`, структура каталогов и документация. |

## 13. Дополнительные материалы

- `Docs/percentile_logic.md` — подробная методика расчёта процентных рангов («обогнал»/«обогнали», глобально и внутри ТерБанка, с фильтром ≥0). Код и комментарии в `src/main.py` ссылаются на этот документ.
- `Docs/sheets_description.md` — описание листов Excel (устаревшая версия, актуальная информация включена в этот README).
- `src/Tests/README.md` — инструкция по тестированию до появления автотестов.
