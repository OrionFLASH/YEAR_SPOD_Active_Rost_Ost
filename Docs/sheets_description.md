# Описание листов Excel, создаваемых программой

## Общая схема обработки

1. **Загрузка исходных данных**: Читаются файлы T-0 и T-1 из каталога `IN`, очищаются от запрещённых значений, нормализуются идентификаторы.
2. **Построение сценария**: На основе параметров `scenario` формируется единый набор данных с назначением менеджеров.
3. **Агрегация и расчёты**: Строятся деталь, свод по табельным номерам, процентильные метрики.
4. **Выгрузка СПОД**: Подготавливаются данные для системы СПОД в формате Excel и CSV.

---

## Листы Excel

### 1. `DETAIL_SCENARIO` (детальный лист сценария)

**Назначение**: Детальные строки с назначенными клиентскими менеджерами для каждого ключа (ИНН или табельный номер + ТБ).

**Источник данных**: Таблица назначений (`assignment_df`), созданная функцией `build_assignment_table()`.

**Колонки**:
- Ключевые колонки (зависят от `scenario.key_mode` и `scenario.include_tb`):
  - Если `key_mode="client"`: `ИНН` (client_id)
  - Если `key_mode="manager"`: `Табельный номер` (manager_id)
  - Если `include_tb=True`: дополнительно `ТБ` (tb)
- `Таб. номер ВКО (выбранный)` — табельный номер назначенного менеджера
- `ВКО (выбранный)` — ФИО назначенного менеджера
- `Источник` — метка источника назначения:
  - `"LATEST"` — если `manager_assignment="latest"` (выбран последний доступный КМ)
  - `"T0"` или `"T1"` — если `manager_assignment="per_file"` (разделение по файлам)
- `Факт_T0` — сумма факта из файла T-0
- `Факт_T1` — сумма факта из файла T-1
- `Прирост` — разница `Факт_T0 - Факт_T1`

**Логика расчёта**:

1. **`assemble_variant_dataset()`**:
   - Агрегирует факты по ключевым колонкам для T-0 и T-1 отдельно (`aggregate_facts()`)
   - Объединяет результаты по ключам (outer join)
   - Вычисляет прирост: `Прирост = Факт_T0 - Факт_T1`
   - Для каждого ключа определяет доминантного менеджера в T-0 и T-1 (`select_best_manager()` — менеджер с максимальной суммой факта)
   - Выбирает «последнего» менеджера (`build_latest_manager()`): приоритет T-0, затем T-1, иначе заглушка

2. **`build_assignment_table()`**:
   - **Режим `latest`**: Каждая строка получает одного менеджера (последний доступный), весь прирост записывается ему.
   - **Режим `per_file`**: 
     - Если прирост положительный или есть факт в T-0 → создаётся строка с КМ из T-0, прирост = `max(Прирост, 0)`
     - Если прирост отрицательный или есть факт в T-1 → создаётся строка с КМ из T-1, прирост = `min(Прирост, 0)` (в абсолютном значении)
     - Таким образом, положительная часть прироста идёт КМ из T-0, отрицательная — КМ из T-1

3. **`rename_output_columns()`**: Переименовывает внутренние alias в русские названия для вывода.

---

### 2. `SUMMARY_TN` (свод по табельным номерам)

**Назначение**: Агрегированные итоги по выбранным менеджерам (табельный номер + ФИО), опционально с разрезом по ТБ.

**Источник данных**: Таблица назначений (`assignment_df`), агрегированная функцией `build_assignment_summary()`.

**Колонки**:
- `Таб. номер ВКО (выбранный)` — табельный номер менеджера
- `ВКО (выбранный)` — ФИО менеджера
- `ТБ` — территориальный банк (только если `scenario.include_tb=True`)
- `Факт_T0` — сумма фактов T-0 по всем записям менеджера
- `Факт_T1` — сумма фактов T-1 по всем записям менеджера
- `Прирост` — сумма приростов по всем записям менеджера
- `Количество записей` — число детальных строк, попавших в агрегат

**Логика расчёта**:

1. **`build_assignment_summary()`**:
   - Группирует `assignment_df` по колонкам: `Таб. номер ВКО (выбранный)`, `ВКО (выбранный)`, и (если `include_tb=True`) `ТБ`
   - Суммирует числовые колонки: `Факт_T0`, `Факт_T1`, `Прирост`
   - Подсчитывает количество записей в каждой группе

**Особенности**:
- В режиме `per_file` один менеджер может иметь несколько строк (из T-0 и T-1), все они суммируются в итоговую строку менеджера.

---

### 3. `PERCENTILE_TN` (процентильная аналитика)

**Назначение**: Метрики «кого обогнал / кто обогнал меня» на базе свода по табельным номерам.

**Источник данных**: Свод `SUMMARY_TN`, расширенный функцией `append_percentile_columns()`.

**Колонки** (базовые из `SUMMARY_TN` + процентильные):
- Все колонки из `SUMMARY_TN`
- `Обогнал_всего_%` — процент менеджеров, у которых прирост меньше, чем у текущего (глобально)
- `Обогнали_меня_всего_%` — процент менеджеров, у которых прирост больше, чем у текущего (глобально)
- `Обогнал_всего_≥0_%` — аналогично, но только среди менеджеров с приростом ≥ 0
- `Обогнали_меня_всего_≥0_%` — аналогично, но только среди менеджеров с приростом ≥ 0
- `Обогнал_ТерБанк_%` — процент менеджеров внутри того же ТБ, у которых прирост меньше (только если `include_tb=True`)
- `Обогнали_меня_ТерБанк_%` — процент менеджеров внутри того же ТБ, у которых прирост больше (только если `include_tb=True`)
- `Обогнал_ТерБанк_≥0_%` — аналогично, но только среди менеджеров с приростом ≥ 0 внутри ТБ
- `Обогнали_меня_ТерБанк_≥0_%` — аналогично, но только среди менеджеров с приростом ≥ 0 внутри ТБ

**Логика расчёта**:

1. **`append_percentile_columns()`**:
   - Берет колонку `Прирост` из `SUMMARY_TN`
   - Для каждой строки вычисляет процент менеджеров с меньшим/большим приростом:
     - **Глобально**: сравнивает со всеми менеджерами в таблице
     - **Внутри ТБ**: сравнивает только с менеджерами того же ТБ (если `include_tb=True`)
   - Применяет фильтр `≥0`: расчёт только среди менеджеров с неотрицательным приростом
   - Все проценты округляются до 2 знаков после запятой

**Формула процентиля**:
- `Обогнал_% = (количество менеджеров с меньшим значением) / (общее количество - 1) * 100`
- `Обогнали_меня_% = (количество менеджеров с большим значением) / (общее количество - 1) * 100`

**Форматирование**: В Excel процентильные колонки имеют формат `#,##0.00` (разделитель тысяч, 2 знака после запятой).

---

### 4. `CALC_SCENARIO` (расчётный лист для СПОД)

**Назначение**: Исходная таблица, на основе которой строится выгрузка СПОД для основного сценария.

**Источник данных**: Зависит от `spod_variants[0].source_type` (по умолчанию `"scenario_summary"`), то есть `SUMMARY_TN`.

**Колонки**: Те же, что в источнике (обычно `SUMMARY_TN`).

**Логика**: Это копия исходной таблицы без изменений, используется для проверки расчётов перед выгрузкой в СПОД.

**Условие создания**: Лист создаётся только если:
- В `spod_variants` есть вариант с `calc_sheet_name="CALC_SCENARIO"`
- Этот вариант разрешён в `report_layout.spod_variants`
- `calc_sheet_name` разрешён в `report_layout.calc_sheets`

---

### 5. `SPOD_SCENARIO` (выгрузка СПОД для основного сценария)

**Назначение**: Данные для загрузки в систему СПОД на основе свода по табельным номерам.

**Источник данных**: `SUMMARY_TN` (через `source_type="scenario_summary"`).

**Колонки** (стандартный формат СПОД):
- `MANAGER_PERSON_NUMBER` — табельный номер менеджера (20 символов, заполнение нулями слева)
- `CONTEST_CODE` — код конкурса (из `spod_variants[0].contest_code`)
- `TOURNAMENT_CODE` — код турнира (из `spod_variants[0].tournament_code`)
- `CONTEST_DATE` — дата конкурса в формате ISO (из `spod_variants[0].contest_date`, преобразуется `DD/MM/YYYY` → `YYYY-MM-DD`)
- `PLAN_VALUE` — плановое значение (из `spod_variants[0].plan_value`, формат `0.00000`)
- `FACT_VALUE` — фактическое значение (колонка `Прирост` из источника, формат `0.00000`)
- `priority_type` — приоритет (из `spod_variants[0].priority`)

**Логика расчёта**:

1. **`build_spod_dataset()`**:
   - Применяет фильтр к колонке `Прирост`: `fact_value_filter=">0"` (только положительные приросты)
   - Сортирует по убыванию `Прирост`
   - Форматирует табельный номер: длина 20 символов, заполнение нулями слева
   - Форматирует числовые значения: `format_decimal_string()` → формат `0.00000` (5 знаков после запятой)
   - Добавляет метаданные конкурса

**Условие создания**: Лист создаётся только если вариант `SPOD_SCENARIO` разрешён в `report_layout.spod_variants`.

---

### 6. `CALC_SCENARIO_PERC` (расчётный лист для процентильного СПОД)

**Назначение**: Исходная таблица с процентильными метриками для выгрузки СПОД.

**Источник данных**: `PERCENTILE_TN` (через `source_type="scenario_percentile"`).

**Колонки**: Те же, что в `PERCENTILE_TN`.

**Условие создания**: Аналогично `CALC_SCENARIO`, но для варианта `SPOD_SCENARIO_PERCENTILE`.

---

### 7. `SPOD_SCENARIO_PERC` (выгрузка СПОД для процентилей)

**Назначение**: Данные для загрузки в СПОД на основе процентильных метрик.

**Источник данных**: `PERCENTILE_TN` (через `source_type="scenario_percentile"`).

**Колонки**: Стандартный формат СПОД (см. `SPOD_SCENARIO`).

**Особенности**:
- В качестве `FACT_VALUE` используется колонка `Обогнал_всего_%` (из `spod_variants[1].value_column`)
- Фильтр: `fact_value_filter=">=0"` (все неотрицательные процентили)
- Остальная логика аналогична `SPOD_SCENARIO`

---

### 8. `RAW_T0` (очищенные исходные данные T-0)

**Назначение**: Исходные данные из файла T-0 после очистки и нормализации, без агрегации.

**Источник данных**: `current_df` (результат `read_source_file()` для файла T-0).

**Колонки** (русские названия):
- `Короткое ТБ` (tb)
- `Полное ГОСБ` (gosb)
- `ФИО` (manager_name)
- `Табельный номер` (manager_id)
- `ИНН` (client_id)
- `Факт` (fact_value) — исходное значение
- `Факт (число)` (fact_value_clean) — преобразованное в число значение

**Логика расчёта**:

1. **`read_source_file()`**:
   - Читает Excel-файл, переименовывает колонки по маппингу
   - Удаляет строки с запрещёнными значениями (`drop_forbidden_rows()`)
   - Нормализует строковые поля (`normalize_string()`)
   - Форматирует идентификаторы (`format_identifier()`): табельный номер до 8 символов, ИНН до 12 символов, заполнение нулями
   - Преобразует факт в число (`safe_to_float()`): заменяет запятую на точку, приводит к `float`

2. **`format_raw_sheet()`**:
   - Переименовывает alias обратно в русские названия
   - Добавляет колонку `Факт (число)` для удобства проверки

---

### 9. `RAW_T1` (очищенные исходные данные T-1)

**Назначение**: Исходные данные из файла T-1 после очистки и нормализации, без агрегации.

**Источник данных**: `previous_df` (результат `read_source_file()` для файла T-1).

**Колонки и логика**: Аналогично `RAW_T0`, но данные из файла T-1.

---

## CSV-файл

### `YEAR_SPOD_Active_Rost_ost_SPOD_YYYYMMDD_HH_MM.csv`

**Назначение**: Объединённая выгрузка всех вариантов СПОД, где `include_in_csv=True`, для загрузки в систему.

**Источник данных**: Объединение всех `spod_dataset_tables`, где `spod_variants[i].include_in_csv=True`.

**Колонки**: Стандартный формат СПОД (см. `SPOD_SCENARIO`).

**Логика**:
- Все DataFrame из `csv_frames` объединяются через `pd.concat()`
- Разделитель: точка с запятой (`;`)
- Квотирование: минимальное (только при необходимости)

**Условие создания**: CSV создаётся только если есть хотя бы один вариант с `include_in_csv=True`.

---

## Управление выводом листов

Все листы создаются только если они разрешены в блоке `report_layout`:

- `detail_sheets`: список детальных листов (по умолчанию `["DETAIL_SCENARIO"]`)
- `summary_sheets`: список сводов (по умолчанию `["SUMMARY_TN"]`)
- `percentile_sheets`: список процентильных листов (по умолчанию `["PERCENTILE_TN"]`)
- `calc_sheets`: список расчётных листов (по умолчанию `["CALC_SCENARIO", "CALC_SCENARIO_PERC"]`)
- `spod_variants`: список вариантов СПОД для вывода (по умолчанию `["SPOD_SCENARIO", "SPOD_SCENARIO_PERCENTILE"]`)
- `raw_sheets`: список исходных листов (по умолчанию `["RAW_T0", "RAW_T1"]`)

Если ключ отсутствует в `report_layout` или равен `None`, все листы блока выводятся. Если список пуст, блок отключается.

---

## Зависимости между листами

```
RAW_T0, RAW_T1 (исходные данные)
    ↓
assemble_variant_dataset() → scenario_dataset
    ↓
build_assignment_table() → assignment_df
    ↓
    ├─→ rename_output_columns() → DETAIL_SCENARIO
    └─→ build_assignment_summary() → SUMMARY_TN
            ↓
            ├─→ append_percentile_columns() → PERCENTILE_TN
            └─→ build_spod_dataset() → SPOD_SCENARIO
                    ↓
                    └─→ CSV (если include_in_csv=True)
```

---

## Примечания

1. **Режим `per_file`**: В детальном листе одна исходная строка может породить две строки (для T-0 и T-1), поэтому итоговое количество строк в `DETAIL_SCENARIO` может быть больше, чем уникальных ключей.

2. **Процентили**: Расчёт ведётся на основе свода по табельным номерам, поэтому один менеджер = одна строка в процентильной таблице.

3. **Форматирование Excel**: Все листы получают единое оформление через `format_excel_sheet()`:
   - Заголовки: жирный шрифт, перенос по словам
   - Данные: перенос по словам
   - Ширина колонок: 70–200 символов (подбирается автоматически)
   - Заморозка панелей: ячейка A2
   - Автофильтр: на весь диапазон
   - Числовые форматы: процентили — `#,##0.00`, факты — `#,##0.00`

4. **Идентификаторы**: Все табельные номера и ИНН приводятся к фиксированной длине с лидирующими нулями согласно настройкам `identifiers`.

