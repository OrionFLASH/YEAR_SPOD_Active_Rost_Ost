# Логика вычисления процентного ранга для каждой строки

В данном файле описаны алгоритмы расчёта доли «обогнал» и «обогнали» для каждой строки исходной таблицы сотрудников, как среди всех, так и только внутри ТерБанка. Также описаны формулы для варианта с ограничением по показателю (≥ 0) и соответствующий Python-код.

---

## Исходные данные

| Табельный номер | ТерБанк | Показатель |
|---|---|---|
| ... | ... | ... |

---

## Формулы расчёта

### 1. Среди всех участников

Для строки `i`:
- \(N_{\text{всего}}\) — всего строк
- \(N_{\text{меньше}}\) — количество строк, где показатель < показателя строки `i`
- \(N_{\text{больше}}\) — количество строк, где показатель > показателя строки `i`
- \(N_{\text{равно}}\) — количество строк, где показатель = показателю строки `i` (включая саму строку)

#### Обогнал всего, процент:
\[
\text{Обогнал\_всего\_%} = \frac{N_{\text{меньше}} + 0{,}5 \cdot (N_{\text{равно}} - 1)}{N_{\text{всего}}} \times 100
\]

#### Обогнали меня, процент:
\[
\text{Обогнали\_меня\_всего\_%} = \frac{N_{\text{больше}} + 0{,}5 \cdot (N_{\text{равно}} - 1)}{N_{\text{всего}}} \times 100
\]

---

### 2. Только внутри ТерБанка

Для строки `i`, где ТерБанк = X:
- \(N_{\text{терБанк}}\) — количество строк с ТерБанк = X
- \(N_{\text{меньше\_терБанк}}\) — строк с ТерБанк = X и показателем < показателя строки `i`
- \(N_{\text{больше\_терБанк}}\) — строк с ТерБанк = X и показателем > показателя строки `i`
- \(N_{\text{равно\_терБанк}}\) — строк с ТерБанк = X, показателем = показателю строки `i` (включая саму строку)

#### Обогнал ТерБанк, процент:
\[
\text{Обогнал\_ТерБанк\_%} = \frac{N_{\text{меньше\_терБанк}} + 0{,}5 \cdot (N_{\text{равно\_терБанк}} - 1)}{N_{\text{терБанк}}} \times 100
\]

#### Обогнали меня ТерБанк, процент:
\[
\text{Обогнали\_меня\_ТерБанк\_%} = \frac{N_{\text{больше\_терБанк}} + 0{,}5 \cdot (N_{\text{равно\_терБанк}} - 1)}{N_{\text{терБанк}}} \times 100
\]

---

### 3. С ограничением по показателю (только ≥ 0)

#### 3.1. Среди всех с показателем ≥ 0

Для строки `i` с показателем ≥ 0:
- \(N_{\text{всего\_0}}\) — количество строк с показателем ≥ 0
- \(N_{\text{меньше\_0}}\) — количество строк с показателем ≥ 0 и < показателя строки `i`
- \(N_{\text{больше\_0}}\) — количество строк с показателем ≥ 0 и > показателя строки `i`
- \(N_{\text{равно\_0}}\) — количество строк с показателем ≥ 0 и = показателю строки `i` (включая себя)

\[
\text{Обогнал\_всего\_≥0\_%} = \frac{N_{\text{меньше\_0}} + 0{,}5 \cdot (N_{\text{равно\_0}} - 1)}{N_{\text{всего\_0}}} \times 100
\]

\[
\text{Обогнали\_меня\_всего\_≥0\_%} = \frac{N_{\text{больше\_0}} + 0{,}5 \cdot (N_{\text{равно\_0}} - 1)}{N_{\text{всего\_0}}} \times 100
\]

Для строк с показателем < 0: результат = 0%

#### 3.2. Только внутри ТерБанк с показателем ≥ 0

Для строки `i` с показателем ≥ 0 и ТерБанк = X:
- \(N_{\text{терБанк\_0}}\) — количество строк с ТерБанк = X и показателем ≥ 0
- \(N_{\text{меньше\_терБанк\_0}}\), \(N_{\text{больше\_терБанк\_0}}\), \(N_{\text{равно\_терБанк\_0}}\) — аналогично выше

\[
\text{Обогнал\_ТерБанк\_≥0\_%} = \frac{N_{\text{меньше\_терБанк\_0}} + 0{,}5 \cdot (N_{\text{равно\_терБанк\_0}} - 1)}{N_{\text{терБанк\_0}}} \times 100
\]

\[
\text{Обогнали\_меня\_ТерБанк\_≥0\_%} = \frac{N_{\text{больше\_терБанк\_0}} + 0{,}5 \cdot (N_{\text{равно\_терБанк\_0}} - 1)}{N_{\text{терБанк\_0}}} \times 100
\]

---

## Python код

### Функция для расчёта процентного ранга

```python
def percentile_rank(subset, value):
    """
    Вычисляет процентный ранг (процент людей с меньшим значением)
    
    Args:
        subset: Series или array с данными для сравнения
        value: значение для расчёта ранга
    
    Returns:
        float: процент людей с меньшим значением (с учётом равных)
    """
    count_less = (subset < value).sum()
    count_equal = (subset == value).sum()
    n = len(subset)
    
    if n == 0:
        return 0
    
    return ((count_less + 0.5 * (count_equal - 1)) / n) * 100
```

### Основная функция расчёта всех метрик

```python
import pandas as pd

def calc_all_metrics(df, show_metric='показатель', ter_bank='ТерБанк'):
    """
    Рассчитывает все 8 метрик процентного ранга
    
    Args:
        df: DataFrame с колонками [show_metric, ter_bank]
        show_metric: название колонки с показателем (default: 'показатель')
        ter_bank: название колонки с ТерБанком (default: 'ТерБанк')
    
    Returns:
        DataFrame с добавленными 8 колонками метрик
    """
    
    result = df.copy()
    
    # Вспомогательная функция для обратного ранга ("Обогнали меня")
    def percentile_rank_reverse(subset, value):
        count_greater = (subset > value).sum()
        count_equal = (subset == value).sum()
        n = len(subset)
        
        if n == 0:
            return 0
        
        return ((count_greater + 0.5 * (count_equal - 1)) / n) * 100
    
    # 1. Обогнал всего (среди всех)
    result['Обогнал_всего_%'] = result[show_metric].apply(
        lambda x: percentile_rank(result[show_metric], x)
    )
    
    # 2. Обогнали меня всего (среди всех)
    result['Обогнали_меня_всего_%'] = result[show_metric].apply(
        lambda x: percentile_rank_reverse(result[show_metric], x)
    )
    
    # 3. Обогнал ТерБанк (только внутри ТерБанка)
    result['Обогнал_ТерБанк_%'] = result.apply(
        lambda row: percentile_rank(
            result[result[ter_bank] == row[ter_bank]][show_metric],
            row[show_metric]
        ),
        axis=1
    )
    
    # 4. Обогнали меня ТерБанк (только внутри ТерБанка)
    result['Обогнали_меня_ТерБанк_%'] = result.apply(
        lambda row: percentile_rank_reverse(
            result[result[ter_bank] == row[ter_bank]][show_metric],
            row[show_metric]
        ),
        axis=1
    )
    
    # Фильтр для ограничения ≥ 0
    mask_all = result[show_metric] >= 0
    
    # 5. Обогнал всего ≥ 0 (только среди с показателем ≥ 0)
    result['Обогнал_всего_≥0_%'] = result.apply(
        lambda row: percentile_rank(
            result[mask_all][show_metric],
            row[show_metric]
        ) if row[show_metric] >= 0 else 0,
        axis=1
    )
    
    # 6. Обогнали меня всего ≥ 0 (только среди с показателем ≥ 0)
    result['Обогнали_меня_всего_≥0_%'] = result.apply(
        lambda row: percentile_rank_reverse(
            result[mask_all][show_metric],
            row[show_metric]
        ) if row[show_metric] >= 0 else 0,
        axis=1
    )
    
    # 7. Обогнал ТерБанк ≥ 0 (только внутри ТерБанка и с показателем ≥ 0)
    result['Обогнал_ТерБанк_≥0_%'] = result.apply(
        lambda row: percentile_rank(
            result[(result[ter_bank] == row[ter_bank]) & mask_all][show_metric],
            row[show_metric]
        ) if row[show_metric] >= 0 else 0,
        axis=1
    )
    
    # 8. Обогнали меня ТерБанк ≥ 0 (только внутри ТерБанка и с показателем ≥ 0)
    result['Обогнали_меня_ТерБанк_≥0_%'] = result.apply(
        lambda row: percentile_rank_reverse(
            result[(result[ter_bank] == row[ter_bank]) & mask_all][show_metric],
            row[show_metric]
        ) if row[show_metric] >= 0 else 0,
        axis=1
    )
    
    return result
```

### Пример использования

```python
# Загрузить данные
df = pd.read_csv('data.csv')  # или pd.read_excel('data.xlsx')

# Применить расчёты
df_result = calc_all_metrics(df, show_metric='показатель', ter_bank='ТерБанк')

# Сохранить результат
df_result.to_csv('result.csv', index=False)
# или
df_result.to_excel('result.xlsx', index=False)

# Посмотреть результат
print(df_result)
```

---

## Итоговые столбцы в результате

| Столбец | Описание |
|---|---|
| `Обогнал_всего_%` | Доля людей (среди всех), которых я обогнал |
| `Обогнали_меня_всего_%` | Доля людей (среди всех), которые обогнали меня |
| `Обогнал_ТерБанк_%` | Доля людей (внутри моего ТерБанка), которых я обогнал |
| `Обогнали_меня_ТерБанк_%` | Доля людей (внутри ТерБанка), которые обогнали меня |
| `Обогнал_всего_≥0_%` | Доля людей (среди всех с показателем ≥ 0), которых я обогнал |
| `Обогнали_меня_всего_≥0_%` | Доля людей (среди всех с показателем ≥ 0), которые обогнали меня |
| `Обогнал_ТерБанк_≥0_%` | Доля людей (внутри ТерБанка с показателем ≥ 0), которых я обогнал |
| `Обогнали_меня_ТерБанк_≥0_%` | Доля людей (внутри ТерБанка с показателем ≥ 0), которые обогнали меня |

---

## Примечания

- Для строк с показателем < 0 в столбцах с ограничением `_≥0_%` автоматически ставится 0%
- При пустой группе (например, в ТерБанке только 1 человек) результат будет корректен: он будет на 0% (никого не обогнал и его обогнали 0%)
- Для больших таблиц (> 100K строк) можно оптимизировать через numpy vectorization или numba, но текущий код универсален и понятен
- Проверьте названия колонок в вашем файле и подставьте правильные значения в параметры `show_metric` и `ter_bank`
